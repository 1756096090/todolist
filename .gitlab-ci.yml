stages:
  - build
  - test
  - packing
  - deploy
  - code_quality


cache:
  paths:
    - build/libs



build-job:
  stage: build
  image: gradle:jdk17
  script:
    - echo "Setting permissions for gradlew..."
    - chmod +x gradlew
    - echo "Compiling the code..."
    - ./gradlew clean build
    - echo "Compile complete."
  artifacts:
    paths:
      - build/libs/ToDoList-0.0.1-SNAPSHOT.jar

#unit-test-job:
#  stage: test
#  image: gradle:jdk17
#  script:
#    - echo "Setting permissions for gradlew..."
#    - chmod +x ./gradlew
#    - echo "Running unit tests..."
#    - ./gradlew test
#  artifacts:
#    paths:
#      - build/test-results/test/
#    reports:
#      junit: build/test-results/test/TEST-*.xml
#
#integration-test-job:
#  stage: test
#  script:
#    - echo "Running integration tests."



packing-job:
  stage: packing
  image: gradle:jdk17
  before_script:
    - apk update && apk add --no-cache openssh-client
  script:
    - echo "Adjusting key permissions..."
    - chmod 600 "/builds/metodologia-de-desarrollo/todolist.tmp/AWS_KEY"
    - echo "Connecting to EC2 to copy the new version of the application..."
    - scp -o StrictHostKeyChecking=no -i "/builds/metodologia-de-desarrollo/todolist.tmp/AWS_KEY" build/libs/ToDoList-0.0.1-SNAPSHOT.jar ec2-user@18.119.122.90:/home/ec2-user/ToDoList/api.jar




deploy-job:
  image: gradle:jdk17
  stage: deploy
  before_script:
    - apk update && apk add --no-cache openssh-client
  script:
    - echo "Ajustando los permisos de la clave"
    - chmod 600 /builds/metodologia-de-desarrollo/todolist.tmp/AWS_KEY
    - echo "Conectando a EC2 para desplegar la aplicación"
    - echo "Detiene cualquier instancia previa de la API en ejecución"
    - nohup ssh -o StrictHostKeyChecking=no i $AWS KEY ec2-user@18.119.122.90 "nohup pkill -f 'java -jar' > /dev/null 2>&1 &"
    - echo "Ejecuta la nueva versión en segundo plano"
    - nohup ssh -o StrictHostKeyChecking=no -i $AWS_KEY ec2-user@18.119.122.90 "nohup java -jar /home/ec2-user/ToDoList/api.jar > /dev/null 2>&1 &"
  environment: production